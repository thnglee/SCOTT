{% extends 'templates/base.html' %}

{% load static %}

{% block styles %}
    <style>
        .play {
            background-image: url({% static 'image/pause.png' %})
        }

        .pause {
            background-image: url({% static 'image/play.png' %})
        }

    </style>


{% endblock %}

{% block body_style %}
    margin:0; padding:0; background:#121212; font-family:Arial, sans-serif; color:#fff;
{% endblock %}

{% block content %}
    <div hx-history-elt>
        <div class="sidebar">
            <div class="logo-container ">
                <a href="{% url 'home' %}"
                   hx-get="{% url 'home' %}"
                   hx-target="#swap"
                   hx-swap="outerHTML"
                >
                    <img src="{% static 'image/SCOTT_logo.png' %}" alt="Logo"
                         style="width: 70%; height: auto; margin-left: 20px">
                </a>
            </div>

            <!-- Welcome User -->
            <div class="sidebar-section">

                {% if current_user.is_authenticated %}
                    <div class="profile-image" style="display: flex; justify-content: center; margin-top: 2px">
                        <img src="{{ MEDIA_URL }}{{ current_user.userprofile.get_image_uri }}"
                             alt="User avatar"
                             class="gradient-box">
                    </div>
                    <div style="display: flex; justify-content: center;">
                        <b style="margin-top: 5px">Welcome, {{ current_user.username }}</b>
                    </div>
                {% else %}
                    <div style="display: flex; justify-content: center;">
                        <b style="margin-top: 5px">Welcome,üë§ Stranger</b>
                    </div>
                {% endif %}

                {% if current_user.is_authenticated %}
                    <a href="{% url 'user_profile' current_user.username %}"
                       hx-get="{% url 'user_profile' current_user.username %}"
                       hx-target="#swap"
                       hx-swap="outerHTML"
                       class="sidebar-link {% if request.resolver_match.url_name == 'user_profile' %}active{% endif %}"
                    >
                        <span class="sidebar-link-icon">üë§</span>
                        <b>Profile</b>
                    </a>
                    {% if current_user.userprofile.artist %}
                        <a href="{% url 'artist_workspace' %}"
                           hx-get="{% url 'artist_workspace' %}"
                           hx-target="#swap"
                           hx-swap="outerHTML"
                           class="sidebar-link {% if request.resolver_match.url_name == 'artist_workspace' %}active{% endif %}"
                        >
                            <span class="sidebar-link-icon">üéµ</span>
                            <b>Workspace</b>
                        </a>
                    {% endif %}
                    <a href="{% url 'logout' %}" class="sidebar-link">
                        <span class="sidebar-link-icon">‚Ü™Ô∏è</span>
                        <b>Logout</b>
                    </a>
                {% else %}
                    <a href="{% url 'login' %}" class="sidebar-link">
                        <span class="sidebar-link-icon">üîë</span>
                        <b>Login</b>
                    </a>
                {% endif %}

            </div>

            <!-- Top section of the sidebar -->
            <div class="sidebar-section">
                <a href="{% url 'home' %}"
                   hx-get="{% url 'home' %}"
                   hx-target="#swap"
                   hx-swap="outerHTML"
                   class="sidebar-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}"
                >
                    <span class="sidebar-link-icon">üè†</span>
                    <b>Home</b>
                </a>
                <a href="{% url 'search_all' %}"
                   hx-get="{% url 'search_all' %}"
                   hx-target="#swap"
                   hx-swap="outerHTML"
                   class="sidebar-link {% if request.resolver_match.url_name == 'search_all' %}active{% endif %}
                                        {% if request.resolver_match.url_name == 'search_song' %}active{% endif %}">
                    <span class="sidebar-link-icon">üîç</span>
                    <strong>Search</strong>
                </a>

            </div>

            <div hx-preserve="true" hx-history="false"  id="pl" class="sidebar-section playlist">
                <a href="{% url 'playlist_info' %}"
                   hx-get="{% url 'playlist_info' %}"
                   hx-target="#swap"
                   hx-swap="outerHTML"
                   class="sidebar-link {% if request.resolver_match.url_name == 'playlist_info' %}active{% endif %}"
                >
                    <span class="sidebar-link-icon">üé∂</span>
                    <b>Library</b>
                </a>

                <div hx-history="false" id="playlist" class="songs">

                </div>

            </div>

        </div>

        <div style="margin-left:190px; padding: 0 20px 100px;">
            <header id="header" class="header-container">
                {% block header %}
                {% endblock %}
            </header>


            <main id="main">
                {% block main %}

                {% endblock %}

            </main>
        </div>
        <script>
            document.addEventListener('htmx:afterSwap', function () {
                window.scrollTo(0, 0);
                loadSongIntoPlaylist();
            });
            function loadSongIntoPlaylist() {
                var playlist = document.getElementById('playlist');
                var MPplaylist = musicPlayer.playlist;

                playlist.innerHTML = '';

                for (var i = 0; i < MPplaylist.length; i++) {
                    var song = MPplaylist[i];
                    var a = document.createElement('a');
                    a.href = '/song/' + song.id +"/info/"
                    a.setAttribute('hx-get', '/song/' + song.id +"/info/");
                    a.setAttribute('hx-target', '#swap');
                    a.setAttribute('hx-swap', 'outerHTML');
                    a.textContent = song.name;

                    playlist.appendChild(a);
                    if (musicPlayer.audioElement.src.includes(song.url)) {
                        a.classList.add('playing');
                    }
                }
                htmx.process(playlist);
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function inc_view_count(songName) {
                var xhr = new XMLHttpRequest();
                var domain = window.location.host;
                var csrftoken = getCookie('csrftoken');
                xhr.open('POST', 'http://' + domain + '/song/inc_view_count/', true);
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
                xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                xhr.send(JSON.stringify({song_name: songName}));
            }

            document.querySelectorAll('.play-button').forEach(function (button) {
                button.addEventListener('click', function () {
                    var songUrl = button.getAttribute('data-url');
                    var songImage = button.getAttribute('data-image');
                    var songArtist = button.getAttribute('data-artist');
                    var songName = button.getAttribute('data-name');
                    var songId = button.getAttribute('data-id');
                    musicPlayer.playSong(songUrl, songImage, songArtist, songName, songId);
                });
            });

            document.querySelectorAll('.add-button').forEach(function (button) {
                button.addEventListener('click', function () {
                    var songUrl = button.getAttribute('data-url');
                    var songImage = button.getAttribute('data-image');
                    var songArtist = button.getAttribute('data-artist');
                    var songName = button.getAttribute('data-name');
                    var songId = button.getAttribute('data-id');
                    musicPlayer.addToPlaylist(songUrl, songImage, songArtist, songName, songId);
                });
            });

            document.querySelectorAll('.add-all-button').forEach(function (button) {
                button.addEventListener('click', function () {
                    var albumInfo = button.getAttribute('data-album');
                    var songInfoArray = JSON.parse(albumInfo);

                    songInfoArray.forEach(function (songInfo) {
                        var songUrl = songInfo.stream_url;
                        var songImage = songInfo.image_uri;
                        var songArtist = songInfo.artist_name;
                        var songName = songInfo.song_name;
                        var songId = songInfo.id;

                        musicPlayer.addToPlaylist(songUrl, songImage, songArtist, songName, songId);
                    });
                });
            });


            document.querySelectorAll('.play-all-button').forEach(function (button) {
                button.addEventListener('click', function () {
                    var albumInfo = button.getAttribute('data-album');
                    var songInfoArray = JSON.parse(albumInfo);
                    musicPlayer.clearPlaylist();
                    musicPlayer.playSong(songInfoArray[0].stream_url, songInfoArray[0].image_uri, songInfoArray[0].artist_name, songInfoArray[0].song_name, songInfoArray[0].id);
                    songInfoArray.forEach(function (songInfo) {
                        var songUrl = songInfo.stream_url;
                        var songImage = songInfo.image_uri;
                        var songArtist = songInfo.artist_name;
                        var songName = songInfo.song_name;
                        var songId = songInfo.id;

                        musicPlayer.addToPlaylist(songUrl, songImage, songArtist, songName, songId);
                    });
                    loadSongIntoPlaylist();
                });
            });

        </script>
    </div>
    <div hx-preserve="true" id="music-player" class="music-player">
        <div class="song-bar">
            <div class="song-infos">
                <div class="image-container">
                    <img src="{{ MEDIA_URL }}{{ '/media/image/song/default.png' }}" alt=""/>
                </div>
                <div class="song-description">
                    <p class="title"></p>
                    <p class="artist"></p>
                </div>
            </div>
        </div>
        <div class="progress-controller">
            <div class="control-buttons">
                <i class="fas fa-random"></i>
                <i class="fas fa-step-backward"></i>
                <i class="play-pause pause"></i>
                <i class="fas fa-step-forward"></i>
                <i class="fas fa-undo-alt"></i>
            </div>
            <div class="progress-container">
                <span style="width: 30px; margin-right: 2px;">0:00</span>
                <div class="progress-bar">
                    <div class="progress"></div>
                </div>
                <span style="width: 30px;">0:00</span>
            </div>
        </div>
        <div class="other-features">
            <div class="volume-bar">
                <i class="fas fa-volume-up" style="width: 15px"></i>
                <div class="progress-bar">
                    <div class="progress"></div>
                </div>
            </div>
        </div>

    </div>

    <script src="{% static 'js/music-player.js' %}"></script>



{% endblock %}